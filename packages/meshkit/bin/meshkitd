#!/bin/bash

CONF=/etc/meshkit/meshkit.default.conf
[ -e /etc/meshkit/meshkit.conf ] && CONF=/etc/meshkit/meshkit.conf

[ "${DEBUG}" = "" ] && DEBUG=0
[ ${DEBUG} = 2 ] && set -x

function log {
	[ ${DEBUG} -gt 0 ] && echo $*
	while [[ "$1" != "" ]] &&  [[ $1 == -* ]]; do
		shift 1
	done
	logger "meshkitd:" "'"$*"'"
}

function die {
	log ${*}
	iw dev mesh0 del &> /dev/null
	killall meshd-nl80211 &> /dev/null
	killall hostapd &> /dev/null
	exit -1
}

function try {
	if [ ${DEBUG} -gt 0 ]; then
		eval $*
		RESULT=$?
	else
		eval $* &> /dev/null
		RESULT=$?
	fi
	if [ ! ${RESULT} -eq 0 ]; then
		log "Failed (${RESULT}).  Trying again in 5s"
		sleep 5
		return 1
	else
		log "Success"
		return 0
	fi
}

# add count $2 to base IP address $1
function increment_ip {
	SUFFIX=$((`echo ${1} | cut -d '.' -f 4` + ${2}))
	NEW_IP=`echo ${1} | cut -d '.' -f 1-3`".${SUFFIX}"
	echo ${NEW_IP}
}

[ -e ${CONF} ] || die "Config file ${CONF} does not exist"

source ${CONF}

# Calculate updated IP addresses if configured to do so
REAL_MESH_IP=${MESH_IP}
REAL_CTL_IP=${CTL_IP}
REAL_INFRA_IP=${INFRA_IP}

if [ -e /etc/distro11s.conf -a -e /etc/distro11s-hostnumber ]; then
	source /etc/distro11s.conf
	if [ -e /etc/distro11s-hostnumber ]; then
		HOSTNUM=`cat /etc/distro11s-hostnumber`
		if [ "${MESH_IP}" != "" ]; then
			REAL_MESH_IP=`increment_ip ${MESH_IP} ${HOSTNUM}`
		fi
		if [ "${CTL_IP}" != "" ]; then
			REAL_CTL_IP=`increment_ip ${CTL_IP} ${HOSTNUM}`
		fi
		if [ "${INFRA_IP}" != "" ]; then
			REAL_INFRA_IP=`increment_ip ${INFRA_IP} ${HOSTNUM}`
		fi
	fi
fi

# start with a clean house
ifconfig -a | grep mesh0 &> /dev/null && iw dev mesh0 del &> /dev/null
killall meshd-nl80211 &> /dev/null
killall hostapd &> /dev/null

if [ "${MESH_IF}" != "" ]; then
	[ "${MESH_CHANNEL}" = "" ] && MESH_CHANNEL=6

	# Generate some dependent parameters
	MESH_BAND=11a
	if [ ${MESH_CHANNEL} -gt 0 -a ${MESH_CHANNEL} -lt 12 ]; then
		MESH_BAND=11g
	fi
	MESHD_LOG=/var/log/authsae.${MESH_IF}.log
	log -n "Starting mesh on ${MESH_IF}..."

	# sigh.  sometimes when we restart meshkit MESH_IF doesn't appear unless we
	# wait for it.  Not sure why.
	sleep 1
	ifconfig -a | grep ${MESH_IF} &> /dev/null || die "No such iface ${MESH_IF}"
	iw dev ${MESH_IF} interface add mesh0 type mesh || die "Failed to add mesh interface"
	iw dev mesh0 set channel ${MESH_CHANNEL} || die "Failed to change to mesh channel"
	ifconfig mesh0 up || die "Failed to bring up mesh interface"

	if [ "${MESH_PASSWORD}" = "" ]; then
		iw dev mesh0 mesh join ${MESH_ID} || die "Failed to join mesh"
	else
		# Set up secure mesh.  Note that first we must create various config
		# files required by authsae
		mkdir -p /var/run/authsae || die "Failed to create authsae config dir"
		echo "$(cat <<EOF
authsae:
{
 sae:
  {
    debug=480;
    password="${MESH_PASSWORD}";
    group=[19, 26, 21, 25, 20];
    blacklist=5;
    thresh=5;
    lifetime=3600;
  };
 meshd:
  {
    meshid="${MESH_ID}";
    interface="mesh0";
    passive=0;
    debug=1;
    mediaopt=1;
    band="${MESH_BAND}";
    channel=${MESH_CHANNEL};
  };
};
EOF
)" > /var/run/authsae/authsae.conf
		meshd-nl80211 -c /var/run/authsae/authsae.conf &> /var/log/authsae.log &
		[ $? -eq 0 ] || die "Failed to launch meshd"
	fi
	# For now, we just support static IP
	ifconfig mesh0 ${REAL_MESH_IP} || die "Failed to set static IP on mesh interface"
	log "Success"
fi

# If our INFRA and CTL interfaces are the same, we have to choose which one to
# honor.  If we can't find the CTL network, do INFRA.  Otherwise to CTL.
if [[ "${INFRA_IF}" != "" ]] && [[ "${CTL_IF}" != "" ]] && [[ "${INFRA_IF}" == "${CTL_IF}" ]]; then
	log -n "Checking for control network ${CTL_SSID}..."
	ifconfig ${CTL_IF} up || die "Failed to bring up control/infra interface"
	iw dev ${CTL_IF} scan | grep -e '[[:space:]]*SSID: '${CTL_SSID}'$' &> /dev/null
	if [ $? -eq 0 ]; then
		log "Found it.  Joining control network."
		INFRA_IF=""
	else
		log "Didn't find it.  Starting AP."
		CTL_IF=""
	fi
fi

if [ "${INFRA_IF}" != "" ]; then
	ifconfig ${INFRA_IF} down || die "failed to bring down infra interface ${INFRA_IF}"

	# prepare the config file
	HOSTAP_CONF=/etc/meshkit/hostapd.default.conf
	[ -e /etc/meshkit/hostapd.conf ] && HOSTAP_CONF=/etc/meshkit/hostapd.conf
	[ -e ${HOSTAP_CONF} ] || die "${HOSTAP_CONF} file does not exist"
	mkdir -p /var/run/hostapd/
	rm -f /var/run/hostapd/hostapd.conf
	while read l; do
		L=`eval echo ${l}`
		[ "${L}" != "" ] && echo ${L} >> /var/run/hostapd/hostapd.conf
	done < ${HOSTAP_CONF}
	hostapd -B /var/run/hostapd/hostapd.conf || die "Failed to launch hostapd"
	ifconfig ${INFRA_IF} ${REAL_INFRA_IP} || die "Failed to set infra IP address"
fi

if [ "${CTL_IF}" != "" ]; then

	ifconfig -a | grep ${CTL_IF} &> /dev/null || die "No such iface ${CTL_IF}"

	# Try over and over to bring up the control interface.
	ifconfig ${CTL_IF} down || die "Failed to bring down control iface"

	while true; do

		log -n "Bringing up control interface ${CTL_IF}..."
		try "ifconfig ${CTL_IF} up" || continue

		if [ "${CTL_SSID}" != "" ]; then
			while true; do
				log -n "Scanning for control network ${CTL_SSID}..."
				try "iw dev ${CTL_IF} scan | grep -e '[[:space:]]*SSID: '${CTL_SSID}'$'" || continue
				break;
			done

			log -n "Connecting to control network ${CTL_SSID}..."
			try iw ${CTL_IF} connect ${CTL_SSID} || continue
			COUNT=20
			while [ ${COUNT} -gt 0 ]; do
				STATUS=`iw wlan1 link | head -1 | awk '{print $1}'`
				if [ "${STATUS}" = "Connected" ]; then
					break;
				fi
				COUNT=$((${COUNT} - 1))
				sleep 1
			done
			if [ ! ${COUNT} -gt 0 ]; then
				log "Failed to connect to ${CTL_SSID}.  Trying again in 5s."
				sleep 5
				continue
			fi
		fi

		# Set the IP address for the ctl interface
		if [ "${REAL_CTL_IP}" = "" ]; then
			log "DHCP unsupported at this time."
			exit 1
		else
			log -n "Assigning IP address..."
			try ifconfig ${CTL_IF} ${REAL_CTL_IP} || continue
		fi

		# If we actually make it all the way to the end, we're connected.  Now
		# we poll to ensure that we stay connected.
		while true; do
			STATUS=`iw wlan1 link | head -1 | awk '{print $1}'`
			if [ "${STATUS}" != "Connected" ]; then
				log "Lost control link.  Re connecting."
				break
			fi
			sleep 5
		done
	done
fi
